
#include <stdlib.h>
#include "hsv_palette.h"

static const hsv_color_t * const hsv_palettes[HSV_PALETTE_COUNT] = {
    hsv_palette_fire,
    hsv_palette_aurora,
    hsv_palette_water,
};

const hsv_color_t *get_hsv_palette(hsv_palette_t palette) {
    if (palette < HSV_PALETTE_COUNT) {
        return hsv_palettes[palette];
    } else {
        return hsv_palettes[0]; // default to first palette
    }
}

// Lookup color in palette with HSV shift (8-bit wraparound per channel)
hsv_color_t hsv_palette_lookup(const hsv_color_t *palette, uint8_t index, hsv_color_t shift) {
    hsv_color_t color = palette[index];
    color.h = (uint8_t)(color.h + shift.h);
    color.s = (uint8_t)(color.s + shift.s);
    color.v = (uint8_t)(color.v + shift.v);
    return color;
}

// --- Standard palette index strategies ---
uint8_t palette_index_multiply(uint8_t contrast, uint8_t gentle, uint8_t modifier) {
    (void)modifier;
    return (uint8_t)(((uint16_t)contrast * (uint16_t)gentle) >> 8);
}

uint8_t palette_index_average(uint8_t contrast, uint8_t gentle, uint8_t modifier) {
    (void)modifier;
    return (uint8_t)(((uint16_t)contrast + (uint16_t)gentle) >> 1);
}

uint8_t palette_index_blend(uint8_t contrast, uint8_t gentle, uint8_t modifier) {
    // modifier: 0 = all contrast, 255 = all gentle
    return (uint8_t)(((uint16_t)(contrast*(255-modifier)) + (uint16_t)(gentle*modifier)) >> 8);
}



// --- Standard brightness strategies ---
// Use palette index as brightness (for classic fire, etc.)
uint8_t brightness_index(const hsv_color_t in, uint8_t palette_index, uint8_t noise_gentle, uint8_t user_brightness) {
    (void)in; (void)noise_gentle;
    // Optionally scale by user_brightness
    return (uint8_t)(((uint16_t)palette_index * user_brightness) >> 8);
}

// Use palette V channel as brightness (preserves palette intent)
uint8_t brightness_value(const hsv_color_t in, uint8_t unused1, uint8_t unused2, uint8_t user_brightness) {
    (void)unused1; (void)unused2;
    return (uint8_t)(((uint16_t)in.v * user_brightness) >> 8);
}

// Use palette V channel plus gentle noise (for shimmer/flicker)
uint8_t brightness_value_noise(const hsv_color_t in, uint8_t unused1, uint8_t noise, uint8_t user_brightness) {
    (void)unused1;
    // Gentle noise is expected to be centered around 128
    int16_t v = (int16_t)in.v + (((int16_t)noise - 128) >> 5); // Small nudge of +/- 8
    if (v < 0) v = 0;
    if (v > 255) v = 255;
    return (uint8_t)(((uint16_t)v * user_brightness) >> 8);
}


const hsv_color_t hsv_palette_water[HSV_PALETTE_SIZE] = {
{0,204,51},{0,205,52},{1,205,53},{1,206,54},{1,207,55},{1,207,56},{2,208,57},{2,209,58},
{2,209,59},{3,210,60},{3,211,61},{3,211,63},{4,212,64},{4,213,65},{4,213,66},{5,214,67},
{5,215,68},{5,215,69},{6,216,70},{6,217,71},{6,217,72},{6,218,73},{7,219,74},{7,220,75},
{7,220,76},{8,221,77},{8,222,79},{8,222,80},{9,223,81},{9,224,82},{9,224,83},{10,225,84},
{10,226,85},{10,226,86},{10,227,87},{11,228,88},{11,228,89},{11,229,90},{12,230,91},{12,230,92},
{12,231,94},{13,232,95},{13,232,96},{13,233,97},{14,234,98},{14,234,99},{14,235,100},{15,236,101},
{15,237,102},{15,237,103},{15,238,104},{16,239,105},{16,239,106},{16,239,107},{16,240,108},{17,240,110},
{17,240,111},{17,241,112},{17,241,113},{17,241,114},{18,241,115},{18,242,116},{18,242,117},{18,242,118},
{18,243,119},{19,243,120},{19,243,121},{19,244,122},{19,244,123},{19,244,124},{20,245,126},{20,245,127},
{20,245,128},{20,246,129},{20,246,130},{21,246,131},{21,247,132},{21,247,133},{21,247,134},{21,248,135},
{22,248,136},{22,248,137},{22,249,138},{22,249,139},{22,249,140},{23,249,142},{23,250,143},{23,250,144},
{23,250,145},{23,251,146},{24,251,147},{24,251,148},{24,252,149},{24,252,150},{24,252,151},{25,253,152},
{25,253,153},{25,253,154},{25,254,155},{25,254,156},{26,254,157},{26,255,159},{26,255,160},{26,255,161},
{25,255,162},{25,254,163},{25,254,165},{25,254,166},{24,254,167},{24,253,168},{24,253,170},{23,253,171},
{23,252,172},{23,252,173},{22,252,175},{22,252,176},{22,251,177},{21,251,178},{21,251,180},{21,251,181},
{20,250,182},{20,250,183},{20,250,185},{20,250,186},{19,249,187},{19,249,188},{19,249,189},{18,249,191},
{18,248,192},{18,248,193},{17,248,194},{17,248,196},{17,247,197},{16,247,198},{16,247,199},{16,247,201},
{15,246,202},{15,246,203},{15,246,204},{15,246,206},{14,245,207},{14,245,208},{14,245,209},{13,245,211},
{13,244,212},{13,244,213},{12,244,214},{12,244,216},{12,243,217},{11,243,218},{11,243,219},{11,243,221},
{10,242,222},{10,242,223},{10,242,223},{10,241,221},{11,241,219},{11,240,217},{11,240,215},{11,239,213},
{12,239,211},{12,239,209},{12,238,208},{12,238,206},{13,237,204},{13,237,202},{13,236,200},{13,236,198},
{13,235,196},{14,235,194},{14,235,192},{14,234,190},{14,234,189},{15,233,187},{15,233,185},{15,232,183},
{15,232,181},{16,232,179},{16,231,177},{16,231,175},{16,230,173},{17,230,172},{17,229,170},{17,229,168},
{17,228,166},{18,228,164},{18,228,162},{18,227,160},{18,227,158},{18,226,156},{19,226,154},{19,225,153},
{19,225,151},{19,224,149},{20,224,147},{20,224,145},{20,223,143},{20,223,141},{21,222,139},{21,222,137},
{21,221,136},{21,221,134},{22,220,132},{22,220,130},{22,220,128},{22,219,126},{22,219,125},{21,219,124},
{21,218,123},{21,218,122},{20,218,121},{20,217,120},{20,217,119},{20,217,118},{19,216,117},{19,216,116},
{19,216,115},{18,216,114},{18,215,113},{18,215,112},{17,215,111},{17,214,110},{17,214,109},{16,214,108},
{16,213,107},{16,213,106},{15,213,105},{15,212,104},{15,212,103},{15,212,102},{14,212,101},{14,211,100},
{14,211,99},{13,211,98},{13,210,97},{13,210,96},{12,210,95},{12,209,94},{12,209,93},{11,209,92},
{11,208,91},{11,208,90},{10,208,89},{10,208,88},{10,207,87},{10,207,86},{9,207,85},{9,206,84},
{9,206,83},{8,206,82},{8,205,81},{8,205,80},{7,205,79},{7,204,78},{7,204,77},{7,204,76},
};

const hsv_color_t hsv_palette_aurora[HSV_PALETTE_SIZE] = {
{69,204,51},{69,204,53},{70,205,54},{70,206,56},{71,206,57},{71,206,59},{72,207,60},{72,208,62},
{73,208,63},{73,209,64},{74,209,66},{74,210,68},{75,210,69},{75,211,70},{76,211,72},{76,212,74},
{77,212,75},{77,212,76},{78,213,78},{78,214,80},{79,214,81},{79,214,82},{80,215,84},{80,216,86},
{81,216,87},{81,216,88},{82,217,90},{82,218,91},{83,218,93},{83,219,94},{84,219,96},{84,220,98},
{85,220,99},{85,220,100},{86,221,102},{86,222,104},{87,222,105},{87,222,106},{88,223,108},{88,224,110},
{89,224,111},{89,224,112},{90,225,114},{90,226,116},{91,226,117},{91,227,118},{92,227,120},{92,228,122},
{93,228,123},{93,228,124},{94,229,126},{94,230,128},{92,230,130},{91,230,132},{89,231,133},{87,232,136},
{85,232,138},{83,232,139},{81,233,142},{80,234,144},{78,234,146},{76,234,147},{74,235,149},{72,236,152},
{70,236,154},{68,236,155},{67,237,157},{65,238,160},{63,238,162},{61,238,163},{59,239,166},{57,240,168},
{55,240,170},{54,240,171},{52,241,173},{50,242,176},{48,242,178},{46,242,179},{44,243,182},{43,244,184},
{41,244,186},{39,244,187},{37,245,189},{35,246,192},{33,246,194},{31,246,195},{30,247,198},{28,248,200},
{26,248,202},{24,248,203},{22,249,205},{20,250,208},{19,250,210},{17,250,211},{15,251,214},{13,252,216},
{11,252,218},{9,252,219},{7,253,221},{6,254,224},{4,254,226},{2,254,227},{0,255,230},{2,255,230},
{5,255,230},{7,255,231},{9,255,232},{12,255,232},{14,255,232},{16,255,233},{19,255,234},{21,255,234},
{23,255,234},{26,255,235},{28,255,235},{31,255,236},{33,255,236},{35,255,237},{38,255,238},{40,255,238},
{42,255,238},{45,255,239},{47,255,240},{49,255,240},{52,255,240},{54,255,241},{56,255,242},{59,255,242},
{61,255,242},{63,255,243},{66,255,243},{68,255,244},{70,255,244},{73,255,245},{75,255,246},{78,255,246},
{80,255,246},{82,255,247},{85,255,248},{87,255,248},{89,255,248},{92,255,249},{94,255,250},{96,255,250},
{99,255,250},{101,255,251},{103,255,251},{106,255,252},{108,255,252},{110,255,253},{113,255,254},{115,255,254},
{117,255,254},{120,255,255},{119,254,254},{119,254,252},{118,254,251},{118,253,249},{117,252,248},{117,252,246},
{116,252,245},{116,251,243},{115,251,242},{115,250,240},{114,250,239},{114,249,237},{113,249,236},{113,248,234},
{112,248,233},{112,247,231},{111,247,230},{111,246,228},{110,246,226},{110,245,225},{109,244,224},{109,244,222},
{108,244,220},{108,243,219},{107,243,218},{107,242,216},{106,242,215},{106,241,213},{105,240,212},{105,240,210},
{104,240,209},{104,239,207},{103,238,206},{103,238,204},{102,238,202},{102,237,201},{101,236,200},{101,236,198},
{100,236,196},{100,235,195},{99,235,194},{99,234,192},{98,234,191},{98,233,189},{97,233,188},{97,232,186},
{96,232,185},{96,231,183},{95,231,182},{95,230,180},{94,230,178},{94,229,176},{93,228,174},{93,228,172},
{92,228,171},{92,227,169},{91,227,167},{91,226,165},{90,226,163},{90,225,160},{89,224,158},{89,224,156},
{88,224,155},{88,223,153},{87,222,151},{87,222,149},{86,222,146},{86,221,144},{85,220,142},{85,220,140},
{84,220,139},{84,219,137},{83,219,135},{83,218,133},{82,218,131},{82,217,128},{81,217,126},{81,216,124},
{80,216,122},{80,215,121},{79,215,119},{79,214,117},{78,214,114},{78,213,112},{77,212,110},{77,212,108},
{76,212,106},{76,211,105},{75,211,103},{75,210,101},{74,210,99},{74,209,96},{73,208,94},{73,208,92},
{72,208,90},{72,207,89},{71,206,87},{71,206,85},{70,206,82},{70,205,80},{69,204,78},{69,204,76},
};

const hsv_color_t hsv_palette_fire[HSV_PALETTE_SIZE] = {
{0,255,76},{0,255,78},{0,255,79},{0,255,80},{0,255,82},{0,255,83},{0,255,84},{0,255,85},
{0,255,86},{0,255,88},{0,255,89},{0,255,90},{0,255,92},{0,255,93},{0,255,94},{0,255,95},
{0,255,96},{0,255,98},{0,255,99},{0,255,100},{0,255,102},{0,255,103},{0,255,104},{0,255,105},
{0,255,106},{0,255,108},{0,255,109},{0,255,110},{0,255,112},{0,255,113},{0,255,114},{0,255,115},
{0,255,117},{0,255,118},{0,255,119},{0,255,120},{0,255,122},{0,255,123},{0,255,124},{0,255,125},
{0,255,126},{0,255,128},{0,255,129},{0,255,130},{0,255,132},{0,255,133},{0,255,134},{0,255,135},
{0,255,137},{0,255,138},{0,255,139},{0,255,140},{0,255,141},{0,255,142},{0,255,142},{0,255,143},
{0,255,144},{0,255,145},{0,255,146},{0,255,146},{0,255,147},{0,255,148},{0,255,148},{0,255,149},
{0,255,150},{0,255,151},{0,255,152},{0,255,152},{0,255,153},{0,255,154},{0,255,155},{0,255,155},
{0,255,156},{0,255,157},{0,255,158},{0,255,158},{0,255,159},{0,255,160},{0,255,160},{0,255,161},
{0,255,162},{0,255,163},{0,255,163},{0,255,164},{0,255,165},{0,255,166},{0,255,166},{0,255,167},
{0,255,168},{0,255,169},{0,255,170},{0,255,170},{0,255,171},{0,255,172},{0,255,172},{0,255,173},
{0,255,174},{0,255,175},{0,255,176},{0,255,176},{0,255,177},{0,255,178},{0,255,178},{0,255,179},
{0,255,179},{0,255,180},{0,255,180},{0,255,181},{0,255,181},{0,255,182},{0,255,182},{0,255,183},
{0,255,184},{0,255,184},{0,255,184},{0,255,185},{0,255,186},{0,255,186},{0,255,186},{0,255,187},
{0,255,187},{0,255,188},{0,255,188},{0,255,189},{0,255,189},{0,255,190},{0,255,190},{0,255,191},
{0,255,192},{0,255,192},{0,255,192},{0,255,193},{0,255,194},{0,255,194},{0,255,194},{0,255,195},
{0,255,195},{0,255,196},{0,255,196},{0,255,197},{0,255,198},{0,255,198},{0,255,198},{0,255,199},
{0,255,200},{0,255,200},{0,255,200},{0,255,201},{0,255,202},{0,255,202},{0,255,202},{0,255,203},
{0,255,203},{0,255,204},{0,255,204},{0,255,204},{0,255,203},{0,255,203},{0,255,203},{0,255,203},
{0,255,202},{0,255,202},{0,255,202},{0,255,202},{0,255,201},{0,255,201},{0,255,201},{0,255,201},
{0,255,200},{0,255,200},{0,255,200},{0,255,200},{0,255,199},{0,255,199},{0,255,199},{0,255,198},
{0,255,198},{0,255,198},{0,255,198},{0,255,198},{0,255,197},{0,255,197},{0,255,197},{0,255,196},
{0,255,196},{0,255,196},{0,255,196},{0,255,196},{0,255,195},{0,255,195},{0,255,195},{0,255,195},
{0,255,194},{0,255,194},{0,255,194},{0,255,194},{0,255,193},{0,255,193},{0,255,193},{0,255,192},
{0,255,192},{0,255,192},{0,255,192},{0,255,192},{0,255,191},{0,255,190},{0,255,189},{0,255,188},
{0,255,187},{0,255,186},{0,255,185},{0,255,184},{0,255,182},{0,255,181},{0,255,180},{0,255,179},
{0,255,178},{0,255,177},{0,255,176},{0,255,175},{0,255,174},{0,255,173},{0,255,172},{0,255,170},
{0,255,169},{0,255,168},{0,255,167},{0,255,166},{0,255,165},{0,255,164},{0,255,163},{0,255,162},
{0,255,161},{0,255,159},{0,255,158},{0,255,157},{0,255,156},{0,255,155},{0,255,154},{0,255,153},
{0,255,152},{0,255,151},{0,255,150},{0,255,148},{0,255,147},{0,255,146},{0,255,145},{0,255,144},
{0,255,143},{0,255,142},{0,255,141},{0,255,140},{0,255,139},{0,255,137},{0,255,136},{0,255,135},
};