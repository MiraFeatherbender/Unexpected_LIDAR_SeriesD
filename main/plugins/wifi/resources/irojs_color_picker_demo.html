<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>iro.js Palette Demo</title>
  <meta name="viewport" content="width=400, initial-scale=1">
  <style>
    body { font-family: sans-serif; margin: 2em; background: #f8f8f8; }
    #picker-container { margin-bottom: 1em; }
    #palette-preview { display: flex; gap: 8px; margin: 1em 0; }
    #hsv-values { font-size: 1.2em; }
  </style>
  <!-- vis.js Graph2d CDN -->
  <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
  <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
</head>
<body>
  <h2>iro.js Palette Demo</h2>
  <p>This demo shows the <a href="https://iro.js.org/" target="_blank">iro.js</a> color picker in multicolor (palette) mode, initialized with the Neutral Fire preset from your Jupyter notebook. Select, add, remove, and adjust palette stops below.</p>
  <div id="picker-container"></div>
  <div id="palette-preview"></div>
  <canvas id="interpolated-bar" width="512" height="48" style="display:block; margin:1em 0; border-radius:6px; border:1px solid #ccc;"></canvas>
  <div id="hsv-values"></div>
    <div id="hsv-values"></div>
    <h3>HSV Curve Editor</h3>
    <div id="hsv-graph2d" style="width: 700px; height: 320px; background: #fff; border-radius: 8px; border: 1px solid #ccc; margin-bottom: 1em;"></div>
  <script src="iro.min.js"></script>
  <script>
    // Neutral Fire preset from Jupyter notebook
    const firePreset = [
      { h: 0, s: 100, v: 30 },
      { h: 0, s: 100, v: 55 },
      { h: 0, s: 100, v: 70 },
      { h: 0, s: 100, v: 80 },
      { h: 0, s: 100, v: 75 },
      { h: 0, s: 100, v: 40 }
    ];

    window.addEventListener('DOMContentLoaded', function() {
      // Create iro.js color picker in multicolor (palette) mode
      var colorPicker = new iro.ColorPicker('#picker-container', {
        width: 320,
        colors: firePreset,
        colorPickerType: 'palette',
        layout: [
          { component: iro.ui.Box },
          { component: iro.ui.Slider, options: { sliderType: 'hue' } },
          { component: iro.ui.Slider, options: { sliderType: 'saturation' } },
          { component: iro.ui.Slider, options: { sliderType: 'value' } }
        ]
      });

      // HSV to RGB conversion (0-360, 0-100, 0-100) â†’ (0-255, 0-255, 0-255)
      function hsvToRgb(h, s, v) {
        s /= 100; v /= 100;
        let c = v * s;
        let x = c * (1 - Math.abs(((h / 60) % 2) - 1));
        let m = v - c;
        let r1, g1, b1;
        if (h < 60)      { r1 = c; g1 = x; b1 = 0; }
        else if (h < 120){ r1 = x; g1 = c; b1 = 0; }
        else if (h < 180){ r1 = 0; g1 = c; b1 = x; }
        else if (h < 240){ r1 = 0; g1 = x; b1 = c; }
        else if (h < 300){ r1 = x; g1 = 0; b1 = c; }
        else             { r1 = c; g1 = 0; b1 = x; }
        return {
          r: Math.round((r1 + m) * 255),
          g: Math.round((g1 + m) * 255),
          b: Math.round((b1 + m) * 255)
        };
      }

      function drawInterpolatedBar() {
        const canvas = document.getElementById('interpolated-bar');
        const ctx = canvas.getContext('2d');
        const stops = colorPicker.colors.map(c => ({ h: c.hsv.h, s: c.hsv.s, v: c.hsv.v }));
        const nStops = stops.length;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let i = 0; i < canvas.width; i+=(canvas.width/256)) {
          // Find which two stops this index is between
          let t = i / (canvas.width - 1) * (nStops - 1);
          let idx = Math.floor(t);
          let frac = t - idx;
          let a = stops[idx];
          let b = stops[Math.min(idx + 1, nStops - 1)];
          // Linear interpolate HSV (hue wraps at 360)
          let dh = ((b.h - a.h + 540) % 360) - 180; // shortest direction
          let h = (a.h + frac * dh + 360) % 360;
          let s = a.s + frac * (b.s - a.s);
          let v = a.v + frac * (b.v - a.v);
          let rgb = hsvToRgb(h, s, v);
          ctx.fillStyle = `rgb(${rgb.r},${rgb.g},${rgb.b})`;
          ctx.fillRect(i, 0, canvas.width/256, canvas.height);
        }
      }

      // Update HSV values, palette preview, and interpolated bar
      function updateHSV() {
        var selectedColor = colorPicker.color;
        var hsv = selectedColor.hsv;
        var h8 = Math.round(hsv.h * 255 / 360);
        var s8 = Math.round(hsv.s * 255 / 100);
        var v8 = Math.round(hsv.v * 255 / 100);
        document.getElementById('hsv-values').innerHTML =
          `<b>Selected HSV:</b> H: ${Math.round(hsv.h)} S: ${Math.round(hsv.s)} V: ${Math.round(hsv.v)}<br>` +
          `<span style='color:#555'>8-bit: <b>H:</b> ${h8} <b>S:</b> ${s8} <b>V:</b> ${v8}</span>`;

        // Debug: log activeColor and its index
        if (colorPicker.activeColor) {
          console.log('Active color index:', colorPicker.activeColor.index, colorPicker.activeColor.hexString);
        } else {
          console.log('No activeColor');
        }

        // Show palette preview
        var paletteDiv = document.getElementById('palette-preview');
        paletteDiv.innerHTML = '';
        colorPicker.colors.forEach(function(c, i) {
          var swatch = document.createElement('div');
          swatch.style.width = '32px';
          swatch.style.height = '32px';
          swatch.style.borderRadius = '50%';
          swatch.style.border = '2px solid #ccc';
          swatch.style.background = c.hexString;
          swatch.title = `Stop ${i+1}: H:${Math.round(c.hsv.h)} S:${Math.round(c.hsv.s)} V:${Math.round(c.hsv.v)}`;
          swatch.style.cursor = 'pointer';
          // Highlight the active color by index
          if (c.index === colorPicker.color.index) {
            swatch.style.outline = '4px solid red';
            swatch.style.outlineOffset = '2px';
          }
          swatch.addEventListener('click', function() {
            colorPicker.setActiveColor(i);
            updateHSV();
          });
          paletteDiv.appendChild(swatch);
        });

        // Draw interpolated color bar
        drawInterpolatedBar();
      }
      colorPicker.on('color:change', updateHSV);
      colorPicker.on('colors:change', updateHSV);
      updateHSV();
    });
  </script>
</body>
</html>
