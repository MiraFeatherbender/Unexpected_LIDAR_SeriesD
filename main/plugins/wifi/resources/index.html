<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AnkleBiter Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; background: #222; color: #eee; text-align: center; }
        :root {
            --grid-col-left: 360px;
            --grid-col-center-min: 800px;
            --grid-col-right: 360px;
            --grid-row-gap: 6px;
            --grid-col-gap: 2em;
            --grid-margin: auto;
            --grid-max-width: 1600px;
            --grid-row-top-height: 370px;

            --col-gap-vertical: 0.2em;

            --panel-bg: #181818;
            --panel-radius: 12px;
            --panel-padding: 16px;
            --panel-min-width: 340px;
            --panel-max-width: 360px;

            --hsv-preview-min: 720px;
            --hsv-preview-max: 800px;
            --blend-min: 340px;
            --blend-max: 360px;
            --editors-max-width: 360px;
            --rgb-min: 340px;
            --rgb-max: 360px;

            --canvas-small-size: 220px;

            --btn-bg: #2a2a2a;
            --btn-bg-hover: #343434;
            --btn-color: #fff;
            --btn-padding: 4px 16px;
            --btn-radius: 4px;
            --btn-font-size: 1.1em;
            --btn-border: none;
            --btn-large-padding: 0.7em 2em;
            --btn-compact-padding: 6px 10px;
            --btn-wide-padding: 6px 24px;
            --btn-secondary-bg: #444;
        }
        /* Grid layout for the main panels: left (large), middle (blend), right (editors / rgb) */
        .img-container {
            display: grid;
            grid-template-columns: var(--grid-col-left) minmax(var(--grid-col-center-min) , 1fr) var(--grid-col-right);
            grid-template-rows: auto auto;
            /* grid-auto-rows: min-content; */
            grid-template-areas:
                "blend hsv-preview editors"
                "blend hsv-editor rgb";
            gap: var(--grid-row-gap) var(--grid-col-gap);
            margin: var(--grid-margin);
            max-width: var(--grid-max-width);
            justify-items: center;
            align-items: start;
        }
        /* Keep column containers as vertical stacks where used */
        .col { display: flex; flex-direction: column; gap: var(--col-gap-vertical); width:100%; }

        .panel { background:var(--panel-bg); border-radius:var(--panel-radius); padding:var(--panel-padding); min-width:var(--panel-min-width); max-width:var(--panel-max-width); display:flex; flex-direction:column; align-items:center; }

        /* Map panels to grid areas so positions can be changed via CSS only */
        #hsv-preview-panel { grid-area: hsv-preview; min-width:var(--hsv-preview-min); max-width:var(--hsv-preview-max); justify-self:center; }
        #hsv-editor-panel { grid-area: hsv-editor; grid-row: 2 / span 1; min-width:var(--hsv-preview-min); max-width:var(--hsv-preview-max); justify-self:center;}
        #blend-panel { grid-area: blend; grid-row: 1 / span 2; align-self: stretch; min-width:var(--blend-min); max-width:var(--blend-max); justify-self:right;}
        #editors-panel { grid-area: editors; width:auto; max-width:var(--rgb-max); justify-self:center; }
        #rgb-ui-panel { grid-area: rgb; min-width:var(--rgb-min); max-width:var(--rgb-max); justify-self:center; }

        /* Panel modifier classes (referencing existing CSS variables; values unchanged) */
        .panel--wide { min-width: var(--hsv-preview-min); max-width: var(--hsv-preview-max); justify-self: center; }
        .panel--hsv-preview { padding-bottom: 0.5em; align-items: center; }
        .panel--small { min-width: var(--blend-min); max-width: var(--blend-max); }
        .panel--editors { max-width: var(--rgb-max); margin: 0; background: var(--panel-bg); border-radius: var(--panel-radius); width: auto; }
        .panel--rgb { min-width: var(--rgb-min); max-width: var(--rgb-max); }

        .btn { font-size: var(--btn-font-size); padding: var(--btn-padding); background: var(--btn-bg); color: var(--btn-color); border: var(--btn-border); border-radius: var(--btn-radius); cursor: pointer; }
        .btn:hover { background: var(--btn-bg-hover); }
        .btn--large { padding: var(--btn-large-padding); border-radius: 6px; }
        .btn--compact { padding: var(--btn-compact-padding); border-radius: 6px; }
        .btn--wide { padding: var(--btn-wide-padding); border-radius: 6px; }
        .btn--secondary { background: var(--btn-secondary-bg); }
        .btn--channel { padding: 6px 18px; border-radius: 4px; font-weight: bold; color: #fff; }
        .btn--hue { background: #e74c3c; }
        .btn--sat { background: #3498db; }
        .btn--val { background: #2ecc40; }
        .btn--muted { opacity: 0.5; }

        img { border: 2px solid #444; background: #111; max-width: 320px; max-height: fit-content; }
        h1 { margin-top: 1em; }

        /* Responsive: stack panels on small viewports */
        @media (max-width: 1100px) {
            .img-container {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "hsv-preview"
                    "hsv-editor"
                    "blend"
                    "editors"
                    "rgb";
            }
            .panel { min-width: 280px; max-width: 100%; width: auto !important; }
            /* Reduce canvas footprints on small screens */
            #hsv-preview-canvas, #ledSim, #blend-canvas { width: var(--canvas-small-size) !important; height: var(--canvas-small-size) !important; }
        }
    </style>
    <!-- All JS libraries loaded in head, before any inline scripts -->
    <script src="iro.min.js"></script>
    <script src="rgb_ui.js"></script>
    <script src="chart.umd.min.js"></script>
    <script src="chartjs-plugin-dragdata.min.js"></script>
    <script src="curve_widget.js"></script>
    <script src="hsv_curve_editor.js"></script>
    <script src="rgbAnimationsEditor.js"></script>
</head>
<body>
    <h1>AnkleBiter Dashboard</h1>
        <div class="img-container">
            <!-- Hidden images for canvas blending -->
            <img id="img-openSimplex2" src="images/openSimplex2.png" alt="openSimplex2 PNG" style="display:none;" crossorigin="anonymous">
            <img id="img-perlinNoise" src="images/perlinNoise.png" alt="perlinNoise PNG" style="display:none;" crossorigin="anonymous">
            <div id="hsv-preview-panel" class="panel panel--wide panel--hsv-preview">
                    <div style="display:flex; flex-direction:row; align-items:center; justify-content:center; margin-top:8px;">
                      <input type="checkbox" id="smoothing-checkbox" style="margin-right:6px;">
                      <label for="smoothing-checkbox" style="color:#ccc; font-size:0.98em; user-select:none; cursor:pointer;">Blur</label>
                    </div>
                    <div style="display: flex; flex-direction: row; justify-content: center; align-items: flex-start; width:100%;">
                        <canvas id="hsv-preview-canvas" width="256" height="256" style="border:2px solid #444; background:#111; max-width:256px; max-height:256px; margin: 0 32px;"></canvas>
                        <canvas id="ledSim" width="256" height="256" style="border:2px solid #444; background:#111; max-width:256px; max-height:256px; margin: 0 32px;"></canvas>
                    </div>
                    <div style="margin-top:18px; display:flex; flex-direction:row; justify-content:center; align-items:center; gap:10px;">
                        <label>min_dx: <input type="number" id="min_dx" value="-1" style="width:40px;"></label>
                        <label>max_dx: <input type="number" id="max_dx" value="1" style="width:40px;"></label>
                        <label>min_dy: <input type="number" id="min_dy" value="0" style="width:40px;"></label>
                        <label>max_dy: <input type="number" id="max_dy" value="1" style="width:40px;"></label>
                        <button id="updateWalk">Update Walk Spec</button>
                    </div>
                </div>
                <!-- HSV Curve Editor Panel (left of blend-panel) -->
                <div id="hsv-editor-panel" class="panel panel--wide">
                    <!-- HSV Curve Editor widget will be rendered here -->
                </div>   
            <div id="blend-panel" class="panel panel--small">
                    <h2 style="margin-bottom:0.5em; color:#eee; font-size:1.1em;">Blended Noise (Canvas)</h2>
                    <canvas id="blend-canvas" width="256" height="256" style="border:2px solid #444; background:#111; max-width:256px; max-height:256px;"></canvas>
                    <div style="margin-top:1em; width:100%;">
                        <label for="blend-slider" style="color:#eee;">Blend Ratio:</label>
                        <input type="range" id="blend-slider" min="0" max="100" value="50" style="width:180px; margin-left:1em;">
                        <span id="blend-value" style="margin-left:0.5em; color:#aaa;">50%</span>
                    </div>
                    <div style="margin-top:0.5em; color:#888; font-size:0.9em;">0% = Perlin, 100% = OpenSimplex2</div>
                    <!-- New palette dropdown and save button -->
                    <div style="margin: 32px 0 0 0; display:flex; flex-direction:row; align-items:center;">
                        <select id="noise-palette-dropdown" style="font-size:1em; padding:4px 12px; border-radius:4px; margin-right:8px;">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <button id="save-curve-btn" class="btn">Save Curve</button>
                    </div>
                    <!-- Curve widget will be injected here -->
                    <div id="curve-widget-container" style="margin-top:16px;"></div>
                </div> 
            <div id="editors-panel" class="panel panel--editors" role="region" aria-label="Upload and editors panel">
                <div style="display:flex; flex-direction:column; align-items:center; gap:0.75em;">
                    <div style="display:flex; gap:0.75em; flex-direction:column; align-items:center; width:100%;">
                        <button id="battery-levels-modal-btn" class="btn btn--large">Edit Battery Levels</button>
                        <button id="editAnimPluginBtn" class="btn btn--large">Edit Animation Parameters</button>
                    </div>
                    <!-- Subpanel: Upload -->
                    <div style="width:100%; display:flex; justify-content:center;">
                        <div style="padding:0; background:transparent; border-radius:0; width:auto; max-width:var(--rgb-max); text-align:center;">
                            <strong style="display:block; margin-bottom:0.4em;">Upload files to a target directory:</strong>
                            <div style="margin-top:0.5em; display:flex; gap:0.5em; justify-content:center; align-items:center;">
                                <label style="color:#ccc;">
                                    <select id="root-upload-dir-dropdown" aria-label="Target directory" style="padding:4px 8px; border-radius:4px; background:#333; color:#eee; border:1px solid #555; min-width:160px;">
                                        <option value="">/ (root)</option>
                                    </select>
                                </label>
                                <button id="refresh-dirs-btn" class="btn btn--compact" aria-label="Refresh directories" title="Refresh directories">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                                      <path d="M23 4v6h-6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                      <path d="M1 20v-6h6" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                      <path d="M3.51 9a9 9 0 0114.13-3.36L23 10" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                      <path d="M20.49 15a9 9 0 01-14.13 3.36L1 14" stroke="#fff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                                    </svg>
                                </button>
                            </div>
                            <div id="root-upload-drop" style="margin:1em auto; padding:0.75em; border:2px dashed #555; background:#333; cursor:pointer; text-align:center; width:260px; height:96px; display:flex; align-items:center; justify-content:center; border-radius:8px; white-space:normal; word-break:break-word; font-size:0.95em;">
                                <div style="line-height:1.2em;">Drag and drop files here<br>to upload to the selected directory</div>
                            </div>
                            <input type="file" id="root-upload-input" multiple style="display:none;">
                        </div>
                    </div>
                </div>
            </div>
                <!-- New RGB UI Panel -->
                <div id="rgb-ui-panel" class="panel panel--rgb">
                    <div id="color-preview" style="width:48px; height:48px; border-radius:50%; border:1px solid #ccc; margin-bottom:1em;"></div>
                    <div id="picker-container"></div>
                    <div id="hsv-values" style="margin-bottom:1em;"></div>
                    <div style="margin-top:1em; width:100%;">
                        <h3 style="margin-bottom:0.5em; color:#eee; font-size:1em;">Brightness</h3>
                        <div id="b-slider-container"></div>
                        <div id="b-value" style="margin-top:0.5em; font-size:1.1em;"></div>
                    </div>
                    <div style="margin-top:1.5em; width:100%;">
                        <label for="animation-dropdown" style="color:#eee;">Animation:</label>
                        <select id="animation-dropdown" style="margin-left:0.5em; min-width:120px;"></select>
                    </div>
                    <button id="apply-btn" class="btn btn--large" style="margin-top:1.5em;">Apply</button>
                </div>
             


        <!-- Update Webpage and Noise Image upload UI removed; functionality moved into the editors panel above -->

        <!-- Upload panel moved into the editors panel above for better grouping -->

        <!-- --- Modal Save Dialog for Curve/Blend --- -->
        <!-- Create dialog elements -->
        <div id="save-curve-dialog" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:10000; justify-content:center; align-items:center; flex-direction:column; font-size:1.1em; font-family:Arial, sans-serif; text-align:center; padding:0; margin:0;">
            <div style="background:#222; border:1px solid #444; border-radius:12px; padding:2em; min-width:320px; max-width:400px; box-shadow:0 4px 24px #000;">
                <div style="font-weight:bold; font-size:1.2em; margin-bottom:1em;">Save Curve & Blend</div>
                <select id="save-palette-dropdown" style="font-size:1em; padding:4px 12px; border-radius:4px; margin-right:8px; width:100%;">
                    <!-- Options will be populated by JavaScript -->
                </select>
                <input type="text" id="new-palette-name" placeholder="New palette name" style="display:none; margin-top:1em; padding:4px 12px; border-radius:4px; width:100%;">
                <div style="margin-top:2em; display:flex; flex-direction:row; justify-content:center; gap:2em;">
                    <button id="confirm-save-btn" class="btn btn--wide">Confirm</button>
                    <button id="cancel-save-btn" class="btn btn--wide btn--secondary">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Modal for Battery Levels Widget -->
<div id="battery-levels-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:transparent; z-index:1000; pointer-events:none;">
  <div style="background:#181818; border-radius:12px; padding:2em; min-width:420px; max-width:900px; position:absolute; top:50px; right:50px; box-shadow:0 4px 24px #000; pointer-events:auto;">
    <div id="battery-levels-widget-container"></div>
  </div>
</div>

        <!-- Modal for RGB Animations Editor -->
        <div id="rgbEditorModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.4); z-index:1000; align-items:center; justify-content:center;">
          <div style="background:#23272a; color:#e0e0e0; border-radius:10px; box-shadow:0 2px 16px #000a; padding:32px 28px; min-width:320px; max-width:90vw; margin:auto; position:relative; top:10vh;">
            <button onclick="document.getElementById('rgbEditorModal').style.display='none'" class="btn btn--secondary" style="position:absolute; top:8px; right:12px; padding:4px 10px;">Close</button>
            <div id="rgbEditorContainer"></div>
          </div>
        </div>

        <script>
    // Expose smoothing toggle globally
    window.centerWeightedSmoothing = false;
    document.addEventListener('DOMContentLoaded', function() {
      var smoothingCheckbox = document.getElementById('smoothing-checkbox');
      if (smoothingCheckbox) {
        smoothingCheckbox.checked = false;
        smoothingCheckbox.addEventListener('change', function() {
          window.centerWeightedSmoothing = smoothingCheckbox.checked;
        });
      }
    });
    // --- Blended Canvas Logic with Curve Widget ---
    const imgOpenSimplex = document.getElementById('img-openSimplex2');
    const imgPerlin = document.getElementById('img-perlinNoise');
    const blendCanvas = document.getElementById('blend-canvas');
    const blendSlider = document.getElementById('blend-slider');
    const blendValue = document.getElementById('blend-value');
    let openSimplexLoaded = false, perlinLoaded = false;
    let brightnessCurve = new Array(256).fill(0);

    // Inject curve widget at bottom of blend-panel
    const blendPanel = document.getElementById('blend-panel');
    const curveWidgetContainer = document.createElement('div');
    curveWidgetContainer.id = 'curve-widget-container';
    curveWidgetContainer.style.marginTop = '0.5em';
    blendPanel.appendChild(curveWidgetContainer);

    // Create curve widget
    const curveWidget = CurveWidget.create({
        container: curveWidgetContainer,
        onChange: arr => {
            brightnessCurve = arr.slice();
            drawBlendedCanvas();
        }
    });

    function drawBlendedCanvas() {
        if (!openSimplexLoaded || !perlinLoaded) return;
        // Use willReadFrequently: true for efficiency
        const ctx = blendCanvas.getContext('2d', { willReadFrequently: true });
        const blend = parseInt(blendSlider.value, 10) / 100;
        ctx.clearRect(0, 0, blendCanvas.width, blendCanvas.height);
        // Draw perlinNoise.png as base
        ctx.globalAlpha = 1 - blend;
        ctx.drawImage(imgPerlin, 0, 0, blendCanvas.width, blendCanvas.height);
        // Draw openSimplex2.png on top
        ctx.globalAlpha = blend;
        ctx.drawImage(imgOpenSimplex, 0, 0, blendCanvas.width, blendCanvas.height);
        ctx.globalAlpha = 1.0;
        // Apply brightness curve as LUT
        let imageData = ctx.getImageData(0, 0, blendCanvas.width, blendCanvas.height);
        let data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
          // Use original brightness as LUT index
          let v = data[i]; // R channel (images are greyscale)
          let idx = Math.max(0, Math.min(255, v));
          let lut = brightnessCurve[idx];
          // Clamp LUT output to 0-255
          let adj = Math.max(0, Math.min(255, lut));
          data[i] = data[i+1] = data[i+2] = adj;
        }
        ctx.putImageData(imageData, 0, 0);
    }

    // Duplicate blend-canvas to hsv-preview-canvas and apply HSV LUT
    function updateHSVPreviewWithLUT() {
        const src = document.getElementById('blend-canvas');
        const dst = document.getElementById('hsv-preview-canvas');
        if (!src || !dst) return;
        const lut = (typeof HSVEditor !== 'undefined' && HSVEditor.getLUT) ? HSVEditor.getLUT() : null;
        if (!lut || lut.length !== 256) return;
        // Use willReadFrequently: true for efficiency
        const srcCtx = src.getContext('2d', { willReadFrequently: true });
        const dstCtx = dst.getContext('2d', { willReadFrequently: true });
        const imgData = srcCtx.getImageData(0, 0, src.width, src.height);
        const data = imgData.data;
        for (let i = 0; i < data.length; i += 4) {
          // Use brightness (R channel, greyscale) as LUT index
          const v = data[i];
          const color = lut[v]; // {r,g,b}
          if (color) {
            data[i] = color.r;
            data[i+1] = color.g;
            data[i+2] = color.b;
          }
          // else leave as is
        }
        dstCtx.putImageData(imgData, 0, 0);
        // --- LED sim color sampling (after LUT, before cursor) ---
        let ledSimColor = { r: 0, g: 0, b: 0 };
        if (typeof x === 'number' && typeof y === 'number') {
          const w = dst.width, h = dst.height;
          if (window.centerWeightedSmoothing) {
            // 3x3 center-weighted smoothing
            const weights = [
              [1,2,1],
              [2,4,2],
              [1,2,1]
            ];
            let sumR = 0, sumG = 0, sumB = 0, sumW = 0;
            for (let dy = -1; dy <= 1; dy++) {
              for (let dx = -1; dx <= 1; dx++) {
                let sx = (x + dx + w) % w;
                let sy = (y + dy + h) % h;
                let idx = (sy * w + sx) * 4;
                let wgt = weights[dy+1][dx+1];
                sumR += imgData.data[idx] * wgt;
                sumG += imgData.data[idx+1] * wgt;
                sumB += imgData.data[idx+2] * wgt;
                sumW += wgt;
              }
            }
            // sumW is 16, so right shift by 4 for integer division
            ledSimColor.r = sumR >> 4;
            ledSimColor.g = sumG >> 4;
            ledSimColor.b = sumB >> 4;
          } else {
            // Single pixel sample
            let sx = ((x % w) + w) % w;
            let sy = ((y % h) + h) % h;
            let idx = (sy * w + sx) * 4;
            ledSimColor.r = imgData.data[idx];
            ledSimColor.g = imgData.data[idx+1];
            ledSimColor.b = imgData.data[idx+2];
          }
        }
        window.ledSimColor = ledSimColor;
        // --- Draw walk pointer: white ring with black outer ring at (x, y) ---
        if (typeof x === 'number' && typeof y === 'number') {
          const cx = x;
          const cy = y;
          dstCtx.save();
          dstCtx.beginPath();
          dstCtx.arc(cx, cy, 9, 0, 2 * Math.PI);
          dstCtx.lineWidth = 3;
          dstCtx.strokeStyle = '#000';
          dstCtx.shadowColor = '#000';
          dstCtx.shadowBlur = 0;
          dstCtx.stroke();
          dstCtx.beginPath();
          dstCtx.arc(cx, cy, 6, 0, 2 * Math.PI);
          dstCtx.lineWidth = 2;
          dstCtx.strokeStyle = '#fff';
          dstCtx.shadowColor = '#fff';
          dstCtx.shadowBlur = 0;
          dstCtx.stroke();
          dstCtx.restore();
        }
    }
    // Patch drawBlendedCanvas to also update hsv-preview-canvas with LUT
    const origDrawBlendedCanvas = drawBlendedCanvas;
    drawBlendedCanvas = function() {
        origDrawBlendedCanvas();
        updateHSVPreviewWithLUT();
    }

    imgOpenSimplex.onload = function() { openSimplexLoaded = true; drawBlendedCanvas(); };
    imgPerlin.onload = function() { perlinLoaded = true; drawBlendedCanvas(); };
    blendSlider.addEventListener('input', function() {
        blendValue.textContent = blendSlider.value + '%';
        drawBlendedCanvas();
    });
    if (imgOpenSimplex.complete) { openSimplexLoaded = true; }
    if (imgPerlin.complete) { perlinLoaded = true; }
    if (openSimplexLoaded && perlinLoaded) drawBlendedCanvas();
    // --- End Blended Canvas Logic ---
        // Root file upload logic
        var rootDrop = document.getElementById('root-upload-drop');
        var rootInput = document.getElementById('root-upload-input');
        var ROOT_DROP_DEFAULT_HTML = '<div style="line-height:1.2em;">Drag and drop files here<br>to upload to the selected directory</div>';
        // Ensure initial markup is the canonical default (useful if JS resets UI)
        rootDrop.innerHTML = ROOT_DROP_DEFAULT_HTML;
        rootDrop.addEventListener('click', function() { rootInput.click(); });
        rootDrop.addEventListener('dragover', function(e) { e.preventDefault(); rootDrop.style.background = '#444'; });
        rootDrop.addEventListener('dragleave', function(e) { e.preventDefault(); rootDrop.style.background = '#333'; });
        rootDrop.addEventListener('drop', function(e) {
            e.preventDefault();
            rootDrop.style.background = '#333';
            handleRootFiles(e.dataTransfer.files);
        });
        rootInput.addEventListener('change', function(e) {
            handleRootFiles(e.target.files);
        });
        function fetchDirectories() {
            fetch('/api/directories')
              .then(r => r.json())
              .then(list => {
                var dd = document.getElementById('root-upload-dir-dropdown');
                if (!dd) return;
                dd.innerHTML = '';
                var opt = document.createElement('option');
                opt.value = '';
                opt.textContent = '/ (root)';
                dd.appendChild(opt);
                list.forEach(function(d) {
                  var o = document.createElement('option');
                  o.value = d;
                  o.textContent = d;
                  dd.appendChild(o);
                });
              })
              .catch(() => {
                console.warn('Failed to fetch directories');
              });
        }

        function handleRootFiles(files) {
            if (!files || files.length === 0) return;
            var dd = document.getElementById('root-upload-dir-dropdown');
            var selected = dd ? dd.value : '';
            Array.from(files).forEach(function(file) {
                // Encode individual path segments so slashes remain separators
                var segs = selected === '' ? [] : selected.split('/').map(encodeURIComponent);
                var encName = encodeURIComponent(file.name);
                var uploadPath = (segs.length ? (segs.join('/') + '/') : '') + encName;
                var url = '/upload/' + uploadPath;
                var xhttp = new XMLHttpRequest();
                xhttp.open('POST', url, true);
                xhttp.send(file);
                xhttp.onload = function() {
                    if (xhttp.status === 200) {
                        rootDrop.innerHTML = 'Uploaded ' + file.name + ' â†’ ' + (selected || '/') + ' successfully!';
                        setTimeout(function() { rootDrop.innerHTML = ROOT_DROP_DEFAULT_HTML; }, 2000);
                        // Refresh directories in case upload created a new directory
                        setTimeout(fetchDirectories, 800);
                    } else {
                        rootDrop.innerHTML = 'Failed to upload ' + file.name + ' (' + xhttp.status + ')';
                        setTimeout(function() { rootDrop.innerHTML = ROOT_DROP_DEFAULT_HTML; }, 2000);
                    }
                };
            });
        }

        // Hook up refresh button and populate dir list on load
        var refreshDirsBtn = document.getElementById('refresh-dirs-btn');
        if (refreshDirsBtn) refreshDirsBtn.addEventListener('click', fetchDirectories);
        document.addEventListener('DOMContentLoaded', fetchDirectories);
        </script>

        <script>
        function uploadImage(type) {
            var input = document.getElementById('upload-' + type);
            var file = input.files[0];
            if (file && file.type === "image/png") {
                var filename = (type === 'openSimplex2') ? 'images/openSimplex2.png' : 'images/perlinNoise.png';
                var xhttp = new XMLHttpRequest();
                xhttp.open("POST", "/upload/" + filename, true);
                xhttp.send(file);
                xhttp.onload = function() { location.reload(); };
            } else {
                showToast("Please select a PNG file.", 'error');
            }
        }

        function uploadIndex() {
            var file = document.getElementById("update-index").files[0];
            if (file && file.name.endsWith(".html")) {
                var xhttp = new XMLHttpRequest();
                xhttp.open("POST", "/upload/index.html", true);
                xhttp.send(file);
                xhttp.onload = function() { location.reload(); };
            } else {
                showToast("Please select an HTML file.", 'error');
            }
        }
        // Initialize HSV Curve Editor
        HSVEditor.init('#hsv-editor-panel');
        HSVEditor.onLUTChange = updateHSVPreviewWithLUT;
        // --- Noise Curves JSON load and dropdown population ---
        let noiseCurvesData = {};
        fetch('Noise_Curves.json')
          .then(res => res.json())
          .then(json => {
            noiseCurvesData = json;
            // Expose palette names and trimmed names globally for widgets
            window.paletteNames = Object.keys(noiseCurvesData);
            window.paletteNamesTrimmed = window.paletteNames.map(
              name => name.substring(name.lastIndexOf('_') + 1)
            );
            const paletteDropdown = document.getElementById('noise-palette-dropdown');
            paletteDropdown.innerHTML = '';
            window.paletteNames.forEach(name => {
              const opt = document.createElement('option');
              opt.value = name;
              opt.textContent = name;
              paletteDropdown.appendChild(opt);
            });
            // Optionally select first palette
            if (paletteDropdown.options.length > 0) {
              paletteDropdown.value = paletteDropdown.options[0].value;
            }
          });
        // --- Palette selection: update blend slider and curve widget ---
const paletteDropdown = document.getElementById('noise-palette-dropdown');
paletteDropdown.addEventListener('change', function() {
  const name = paletteDropdown.value;
  const entry = noiseCurvesData[name];
  if (entry) {
    blendSlider.value = entry.blend_ratio;
    blendValue.textContent = entry.blend_ratio + '%';
    if (curveWidget && typeof curveWidget.setPoints === 'function') {
      curveWidget.setPoints(entry.curve_points);
    }
    drawBlendedCanvas();
  } else {
    // Fallback: keep current blend slider and curve widget settings
  }
});
// Optionally, trigger change event after initial load to sync UI
fetch('Noise_Curves.json')
  .then(res => res.json())
  .then(json => {
    noiseCurvesData = json;
    paletteDropdown.innerHTML = '';
    Object.keys(noiseCurvesData).forEach(name => {
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name;
      paletteDropdown.appendChild(opt);
    });
    if (paletteDropdown.options.length > 0) {
      paletteDropdown.value = paletteDropdown.options[0].value;
      paletteDropdown.dispatchEvent(new Event('change'));
    }
  });

// --- Small contextual save dialog for curve/blend ---
const saveDialog = document.createElement('div');
saveDialog.style.position = 'absolute';
saveDialog.style.background = '#222';
saveDialog.style.border = '1px solid #444';
saveDialog.style.borderRadius = '10px';
saveDialog.style.padding = '1em 1.5em';
saveDialog.style.boxShadow = '0 2px 12px #000';
saveDialog.style.display = 'none';
saveDialog.style.zIndex = '1000';
saveDialog.style.fontSize = '1em';
saveDialog.style.minWidth = '220px';
saveDialog.style.textAlign = 'center';

const dialogDropdown = document.createElement('select');
dialogDropdown.style.fontSize = '1em';
dialogDropdown.style.padding = '4px 12px';
dialogDropdown.style.borderRadius = '4px';
dialogDropdown.style.marginRight = '8px';
saveDialog.appendChild(dialogDropdown);

const newOpt = document.createElement('option');
newOpt.value = '__new__';
newOpt.textContent = 'New...';
dialogDropdown.appendChild(newOpt);

const newNameInput = document.createElement('input');
newNameInput.type = 'text';
newNameInput.placeholder = 'New palette name';
newNameInput.style.display = 'none';
newNameInput.style.marginTop = '0.5em';
saveDialog.appendChild(newNameInput);

const dialogBtns = document.createElement('div');
dialogBtns.style.marginTop = '1em';
dialogBtns.style.display = 'flex';
dialogBtns.style.flexDirection = 'row';
dialogBtns.style.justifyContent = 'center';
dialogBtns.style.gap = '1em';

const confirmBtn = document.createElement('button');
confirmBtn.textContent = 'Confirm';
confirmBtn.style.padding = '4px 16px';
confirmBtn.style.background = '#2a2a2a';
confirmBtn.style.color = '#fff';
confirmBtn.style.border = 'none';
confirmBtn.style.borderRadius = '6px';
confirmBtn.style.cursor = 'pointer';
confirmBtn.className = 'btn';

const cancelBtn = document.createElement('button');
cancelBtn.textContent = 'Cancel';
cancelBtn.style.padding = '4px 16px';
cancelBtn.style.background = '#444';
cancelBtn.style.color = '#fff';
cancelBtn.style.border = 'none';
cancelBtn.style.borderRadius = '6px';
cancelBtn.style.cursor = 'pointer';
cancelBtn.className = 'btn';
dialogBtns.appendChild(confirmBtn);
dialogBtns.appendChild(cancelBtn);
saveDialog.appendChild(dialogBtns);
document.body.appendChild(saveDialog);

function updateDialogDropdown() {
  if (dialogDropdown.value === '__new__') {
    newNameInput.style.display = '';
  } else {
    newNameInput.style.display = 'none';
  }
}
dialogDropdown.addEventListener('change', updateDialogDropdown);

// Ensure saveCurveBtn is defined before attaching event handler
const saveCurveBtn = document.getElementById('save-curve-btn');
saveCurveBtn.addEventListener('click', function(e) {
  // Populate dropdown with palettes + New...
  dialogDropdown.innerHTML = '';
  Object.keys(noiseCurvesData).forEach(name => {
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    dialogDropdown.appendChild(opt);
  });
  dialogDropdown.appendChild(newOpt);
  dialogDropdown.value = paletteDropdown.value;
  updateDialogDropdown();
  newNameInput.value = '';
  // Position dialog below Save Curve button
  const rect = saveCurveBtn.getBoundingClientRect();
  saveDialog.style.left = (rect.left + window.scrollX) + 'px';
  saveDialog.style.top = (rect.bottom + window.scrollY + 8) + 'px';
  saveDialog.style.display = 'block';
});

cancelBtn.addEventListener('click', function() {
  saveDialog.style.display = 'none';
});

confirmBtn.addEventListener('click', function() {
  let name;
  if (dialogDropdown.value === '__new__') {
    name = newNameInput.value.trim();
    if (!name) {
      showToast('Please enter a name.', 'error');
      return;
    }
    if (noiseCurvesData[name]) {
      showToast('Name already exists.', 'error');
      return;
    }
    // Add new option to dropdowns
    const opt = document.createElement('option');
    opt.value = name;
    opt.textContent = name;
    paletteDropdown.appendChild(opt);
    dialogDropdown.insertBefore(opt.cloneNode(true), newOpt);
  } else {
    name = dialogDropdown.value;
  }
  // Get blend and curve data
  const blendRatio = parseInt(blendSlider.value, 10);
  let curvePoints = [];
  if (curveWidget && curveWidget.chart && curveWidget.chart.data && curveWidget.chart.data.datasets[0]) {
    curvePoints = curveWidget.chart.data.datasets[0].data.map(pt => ({ x: pt.x, y: pt.y }));
  }
  // Update JSON
  noiseCurvesData[name] = {
    blend_ratio: blendRatio,
    curve_points: curvePoints
  };
  // Upload JSON
  const jsonStr = JSON.stringify(noiseCurvesData, null, 2);
  const blob = new Blob([jsonStr], { type: 'application/json' });
  var xhttp = new XMLHttpRequest();
  xhttp.open('POST', '/upload/Noise_Curves.json', true);
  xhttp.send(blob);
  xhttp.onload = function() {
    if (xhttp.status === 200) {
      // Now also save the blend-canvas as PNG to images/<name>_Noise_Contrast.png
      try {
        const canvas = document.getElementById('blend-canvas');
        if (canvas) {
          canvas.toBlob(function(pngBlob) {
            if (!pngBlob) {
              showToast('Failed to create PNG for preview.', 'error');
              return;
            }
            const imgXhr = new XMLHttpRequest();
            const safeName = name.replace(/[^a-zA-Z0-9_-]/g, '_');
            // Use images/<name>_Noise_Contrast.png so backend saves to images directory
            const fileName = 'images/' + safeName + '_Noise_Contrast.png';
            imgXhr.open('POST', '/upload/' + fileName, true);
            imgXhr.send(pngBlob);
            imgXhr.onload = function() {
              if (imgXhr.status === 200) {
                showToast('Curve/blend and PNG saved for ' + name + '!', 'success');
                paletteDropdown.value = name;
                paletteDropdown.dispatchEvent(new Event('change'));
                saveDialog.style.display = 'none';
              } else {
                showToast('Curve saved, but PNG upload failed for ' + name, 'error');
              }
            };
          }, 'image/png');
        } else {
          showToast('Curve saved, but preview canvas not found.', 'error');
        }
      } catch (e) {
        showToast('Curve saved, PNG save error: ' + (e && e.message ? e.message : e), 'error');
      }
    } else {
      showToast('Failed to save curve for ' + name, 'error');
    }
  };
});
        </script>
<script src="battery_levels_widget.js"></script>
<script>
// --- Plugin/Palette Association Dropdown Logic ---
function toTitleCase(str) {
  return str.replace(/\w\S*/g, function(txt) {
    return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
  });
}

   // Always build the lists on DOMContentLoaded, independent of any dropdown
   function buildRgbAnimationIdLists() {
     Promise.all([
       fetch('color_palettes.json').then(r => r.json()),
       fetch('/api/rgbJSON').then(r => r.json())
     ]).then(([paletteData, pluginData]) => {
       // Palette names: keys of paletteData.presets or paletteData
       const palettePresets = paletteData.presets ? paletteData.presets : paletteData;
       const paletteNames = Object.keys(palettePresets);
       // Plugin names: strip RGB_PLUGIN_ prefix
       const plugins = (pluginData.plugins || []).map(p => ({
         id: p.id,
         name: p.name && p.name.startsWith('RGB_PLUGIN_') ? p.name.substring(11) : p.name
       }));
       // Normalize for matching
       const paletteNamesLower = paletteNames.map(n => n.toLowerCase());
       // Build TOTAL list: plugin names (stripped, original order) first, then palette names not already present (case-insensitive)
       const totalNames = [];
       const totalNamesLower = [];
       plugins.forEach(p => {
         totalNames.push(p.name);
         totalNamesLower.push(p.name.toLowerCase());
       });
       paletteNames.forEach(name => {
         if (!totalNamesLower.includes(name.toLowerCase())) {
           totalNames.push(name);
           totalNamesLower.push(name.toLowerCase());
         }
       });
       // Expose the TOTAL list (with indices and names) globally for use in the RGB Animations Editor
       // Also expose the filtered palette-based list
       window.rgbAnimationIdNames = totalNames.map((name, idx) => ({ id: idx, name: toTitleCase(name) }));
       window.rgbAnimationPaletteIdNames = totalNames.map((name, idx) => ({
         id: idx,
         name: toTitleCase(name),
         isPaletteBased: paletteNamesLower.includes(name.toLowerCase())
       })).filter(entry => entry.isPaletteBased);
     }).catch(() => {
       window.rgbAnimationIdNames = [];
       window.rgbAnimationPaletteIdNames = [];
     });
   }
   document.addEventListener('DOMContentLoaded', buildRgbAnimationIdLists);
// Removed calls to updatePluginAssociationDropdown (function not defined)
</script>
<script>
function openBatteryLevelsModal() {
  document.getElementById('battery-levels-modal').style.display = 'flex';
  // Only create widget if not already present
  if (!document.getElementById('battery-levels-widget-container').hasChildNodes()) {
    createBatteryLevelsWidget(document.getElementById('battery-levels-widget-container'), {
      onSave: function(blob) {
        // Save to server using POST, like curve save
        var xhttp = new XMLHttpRequest();
        xhttp.open('POST', '/upload/Battery_Levels.json', true);
        xhttp.onload = function() {
          if (xhttp.status === 200) {
            showToast('Battery_Levels.json uploaded successfully!', 'success');
            closeBatteryLevelsModal();
          } else {
            showToast('Failed to upload Battery_Levels.json', 'error');
          }
        };
        xhttp.onerror = function() {
          showToast('Error uploading Battery_Levels.json', 'error');
        };
        xhttp.send(blob);
      },
      onCancel: function() {
        closeBatteryLevelsModal();
      }
    });
  }
}
function closeBatteryLevelsModal() {
  document.getElementById('battery-levels-modal').style.display = 'none';
  // Do NOT clear widget container, so data remains for next use
  // document.getElementById('battery-levels-widget-container').innerHTML = '';
}
document.getElementById('battery-levels-modal-btn').onclick = openBatteryLevelsModal;
</script>
<script>
// --- LED Simulation Logic ---
let min_dx = -1, max_dx = 1, min_dy = 0, max_dy = 1;
let x = 128, y = 128; // Start in the center
let ledSimAnimFrame = null;
let lastFrameTime = 0;
const LED_SIM_FPS = 30;
const LED_SIM_FRAME_MS = 1000 / LED_SIM_FPS;

function stepWalk() {
    x += Math.floor(Math.random() * (max_dx - min_dx + 1)) + min_dx;
    y += Math.floor(Math.random() * (max_dy - min_dy + 1)) + min_dy;
    x = ((x % 256) + 256) % 256;
    y = ((y % 256) + 256) % 256;
}

function getColorFromCanvas(ctx, x, y) {
    const pixel = ctx.getImageData(x, y, 1, 1).data;
    return `rgb(${pixel[0]},${pixel[1]},${pixel[2]})`;
}

function drawLedSim() {
    const ledSim = document.getElementById('ledSim');
    const ledCtx = ledSim.getContext('2d');
    ledCtx.clearRect(0, 0, 256, 256);
    // Use the color sampled in updateHSVPreviewWithLUT
    const c = window.ledSimColor || { r: 0, g: 0, b: 0 };
    const color = `rgb(${c.r},${c.g},${c.b})`;
    ledCtx.beginPath();
    ledCtx.arc(128, 128, 40, 0, 2 * Math.PI);
    ledCtx.fillStyle = color;
    ledCtx.shadowColor = color;
    ledCtx.shadowBlur = 30;
    ledCtx.fill();
    ledCtx.shadowBlur = 0;
}

function animateLedSim(now) {
    if (!lastFrameTime || now - lastFrameTime >= LED_SIM_FRAME_MS) {
      stepWalk();
      drawLedSim();
      updateHSVPreviewWithLUT(); // Update cursor position every frame
      lastFrameTime = now;
    }
    ledSimAnimFrame = requestAnimationFrame(animateLedSim);
}

document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('updateWalk').onclick = function() {
        min_dx = parseInt(document.getElementById('min_dx').value, 10);
        max_dx = parseInt(document.getElementById('max_dx').value, 10);
        min_dy = parseInt(document.getElementById('min_dy').value, 10);
        max_dy = parseInt(document.getElementById('max_dy').value, 10);
    };
    if (ledSimAnimFrame) cancelAnimationFrame(ledSimAnimFrame);
    lastFrameTime = 0;
    animateLedSim(performance.now());
});
// --- End LED Simulation Logic ---
</script>
<script>
document.getElementById('editAnimPluginBtn').onclick = function() {
  document.getElementById('rgbEditorModal').style.display = 'flex';
  // Only initialize once
  if (!window.rgbEditorLoaded) {
    window.rgbEditorLoaded = true;
    fetch('rgb_animations.json')
      .then(r => r.json())
      .then(json => {
        if (json && Array.isArray(json.animations)) {
          createRgbAnimationsEditor(document.getElementById('rgbEditorContainer'), { animations: json.animations, idNameList: window.rgbAnimationIdNames, paletteIdNameList: window.rgbAnimationPaletteIdNames });
        } else {
          createRgbAnimationsEditor(document.getElementById('rgbEditorContainer'), { idNameList: window.rgbAnimationIdNames, paletteIdNameList: window.rgbAnimationPaletteIdNames });
        }
      })
      .catch(() => {
        createRgbAnimationsEditor(document.getElementById('rgbEditorContainer'), { idNameList: window.rgbAnimationIdNames });
      });
  }
};
</script>
<script>
// --- Populate List 1 and List 2 dropdowns with image file names from server endpoint ---
function populateImageDropdowns() {
  fetch('/api/images')
    .then(r => r.json())
    .then(list => {
      // list should be an array of filenames
      const list1 = document.getElementById('list1-dropdown');
      const list2 = document.getElementById('list2-dropdown');
      const list3 = document.getElementById('list3-dropdown');
      // Expose filtered lists globally
      window.Palette_PNG_List = list.filter(name => name.endsWith('_Palette.png'));
      window.Contrast_PNG_List = list.filter(name => name.endsWith('_Contrast.png') || name === 'openSimplex2.png');
      window.Brightness_PNG_List = list.filter(name => name.endsWith('_Brightness.png') || name === 'perlinNoise.png');

      if (list1) {
        list1.innerHTML = '';
        window.Palette_PNG_List.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          list1.appendChild(opt);
        });
      }
      if (list2) {
        list2.innerHTML = '';
        window.Contrast_PNG_List.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          list2.appendChild(opt);
        });
      }
      if (list3) {
        list3.innerHTML = '';
        window.Brightness_PNG_List.forEach(name => {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          list3.appendChild(opt);
        });
      }
    })
    .catch(() => {
      // On error, clear dropdowns
      const list1 = document.getElementById('list1-dropdown');
      const list2 = document.getElementById('list2-dropdown');
      const list3 = document.getElementById('list3-dropdown');
      if (list1) list1.innerHTML = '';
      if (list2) list2.innerHTML = '';
      if (list3) list3.innerHTML = '';
    });
}
document.addEventListener('DOMContentLoaded', populateImageDropdowns);
</script>
</body>
</html>
